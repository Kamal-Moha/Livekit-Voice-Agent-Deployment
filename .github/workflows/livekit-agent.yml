name: Deploy LiveKit Agent to GCE  Github Workflow 

on:
  push:
    branches: [main]

permissions:
  contents: read
  id-token: write # Required for Workload Identity Federation
env:
  GCP_VM_NAME: new-myride-wallet-voice

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code 🗳️
        uses: actions/checkout@v4

      - name: Authenticate with Google Cloud 🔒🔑🔓☁️
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud SDK 🪛⚙️
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      - name: Zip source code (exclude .git) 🤐
        run: |
          zip -r livekit-agent.zip . -x ".git/*"

      - name: Upload ZIP to VM ⬆️☁️🖥️
        run: |
          gcloud compute scp livekit-agent.zip bhadala_kamalmohapy@${GCP_VM_NAME}:~ --zone=us-central1-f

      - name: Prepare and deploy on VM 🚀🖥️ 🤖💅🏽
        run: |
          gcloud compute ssh bhadala_kamalmohapy@${GCP_VM_NAME} --zone=us-east1-d --command='
            set -e
            echo "Cleaning previous deployment..."
            rm -rf ~/livekit-agent
            mkdir ~/livekit-agent

            echo "Unzipping..."
            unzip -o ~/livekit-agent.zip -d ~/livekit-agent

            echo "Building Docker image..."
            cd ~/Livekit-Voice-Agent-Deployment
            docker build -t livekit-agent .

            echo "Restarting container..."
            docker stop livekit-agent || true
            docker rm livekit-agent || true
            docker run \
            --memory="12gb" \
            --cpus="14.0" \
            -d \
            --env-file /home/bhadala_kamalmohapy/.env \
            --name livekit-agent livekit-agent

            echo "Cleaning up unused images..."
            docker image prune -f || true
